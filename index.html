<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZC 門市績效系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #fdf2f8; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        label { font-weight: 600; color: #4b5563; margin-bottom: 0.4rem; display: block; }
        input, select, textarea { 
            width: 100%; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 10px; margin-bottom: 1rem; font-size: 16px;
        }
        input:focus, textarea:focus { outline: none; border-color: #ec4899; box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); }
        .section-title { border-left: 5px solid #ec4899; padding-left: 0.75rem; margin: 1.5rem 0 1rem 0; font-size: 1.1rem; font-weight: bold; color: #be185d; }
        .perf-row { background: #fff1f2; padding: 1.25rem; border-radius: 12px; margin-bottom: 1rem; border: 1px dashed #fda4af; }
        #loadingOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 50; align-items: center; justify-content: center; color: white; flex-direction: column; }
        optgroup { font-weight: bold; color: #ec4899; font-style: normal; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- 讀取遮罩 -->
    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-pink-500 border-t-transparent mb-4"></div>
        <p class="font-bold text-lg text-white">正在連線至系統...</p>
        <p class="text-pink-200">請勿關閉視窗</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">《ZC》人員績效回報</h1>
            <p class="text-pink-600 font-medium">門市人員績效與店務反饋</p>
        </header>

        <form id="storeForm" class="card p-6 mb-6">
            <div class="section-title">基本資訊</div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label>回報單位</label>
                    <select name="store_name" id="store_name" required>
                        <option value="">選擇單位</option>
                        <option value="中原門市">中原門市</option>
                        <option value="中山門市">中山門市</option>
                        <option value="新竹門市">新竹門市</option>
                        <option value="倉儲中心">倉儲中心</option>
                    </select>
                </div>
                <div><label>日期</label><input type="date" name="date" id="date" required></div>
                <div>
                    <label>星期</label>
                    <select name="weekday" id="weekday">
                        <option value="一">一</option><option value="二">二</option><option value="三">三</option>
                        <option value="四">四</option><option value="五">五</option><option value="六">六</option>
                        <option value="日">日</option>
                    </select>
                </div>
            </div>

            <div class="section-title">人員績效明細 (個績)</div>
            <div id="staffContainer">
                <div class="perf-row staff-group">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                        <div>
                            <label>銷售人員</label>
                            <select name="staff_name[]" class="staff-select" required>
                                <option value="">選人員</option>
                                <optgroup label="中原店">
                                    <option value="旗旗 zc77">旗旗 zc77</option>
                                    <option value="柔柔 zc66">柔柔 zc66</option>
                                </optgroup>
                                <optgroup label="中山店">
                                    <option value="庭庭 zctt">庭庭 zctt</option>
                                    <option value="雯雯 zc55">雯雯 zc55</option>
                                </optgroup>
                                <optgroup label="支援/行政">
                                    <option value="庭苡">庭苡</option>
                                    <option value="彥翔">彥翔</option>
                                    <option value="阿姨">阿姨</option>
                                </optgroup>
                                <optgroup label="其他">
                                    <option value="支援人員">支援人員</option>
                                </optgroup>
                            </select>
                        </div>
                        <div><label>銷售件數</label><input type="number" name="staff_count[]" value="0"></div>
                        <div><label>VIP開發</label><input type="number" name="staff_vip[]" value="0"></div>
                        <div><label>展示照片</label><input type="number" name="photo_show[]" value="0"></div>
                    </div>
                </div>
            </div>
            <button type="button" onclick="addStaff()" class="text-sm text-pink-600 font-bold mb-4">+ 新增人員欄位</button>

            <div class="section-title">分析與回饋</div>
            <label>門店現況分析 (環境、客群、效率)</label>
            <textarea name="analysis" rows="3" placeholder="請填寫今日觀察..."></textarea>
            
            <label>熱銷排名 / 顧客尋找商品</label>
            <textarea name="feedback" rows="2" placeholder="1. &#10;2. "></textarea>

            <label>需補商品 / 備品 / 異常事項</label>
            <textarea name="restock" rows="2"></textarea>

            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button type="submit" id="submitBtn" class="flex-1 bg-pink-600 text-white font-bold py-4 rounded-xl hover:bg-pink-700 active:scale-95 transition shadow-lg">儲存數據並送出</button>
                <button type="button" onclick="generatePreview()" class="flex-1 bg-gray-600 text-white font-bold py-4 rounded-xl hover:bg-gray-700 active:scale-95 transition">僅預覽 LINE 文字</button>
            </div>
        </form>

        <div id="resultContainer" class="card p-6 hidden">
            <h2 class="text-xl font-bold mb-4 flex justify-between items-center text-pink-700">
                LINE 回報預覽
                <button onclick="copyToClipboard()" class="text-sm bg-pink-100 text-pink-700 px-3 py-1 rounded hover:bg-pink-200">複製報告</button>
            </h2>
            <pre id="resultText" class="whitespace-pre-wrap bg-gray-50 p-4 rounded border text-gray-700 text-sm"></pre>
        </div>
    </div>

    <script>
        // 【已嵌入您提供的網址】
        const scriptURL = 'https://script.google.com/macros/s/AKfycby9QLEMRA_wJUFImeJqNyN-GXkNpFim1MYuPHCCy-HJctbUvHpnpVqVpKVkcuymu8kJhA/exec'; 

        // 初始化日期
        document.getElementById('date').valueAsDate = new Date();
        const dayMap = ['日','一','二','三','四','五','六'];
        document.getElementById('weekday').value = dayMap[new Date().getDay()];

        function addStaff() {
            const container = document.getElementById('staffContainer');
            const sourceSelect = document.querySelector('.staff-select');
            const div = document.createElement('div');
            div.className = 'perf-row staff-group';
            div.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div><label>銷售人員</label><select name="staff_name[]" class="staff-select">${sourceSelect.innerHTML}</select></div>
                    <div><label>銷售件數</label><input type="number" name="staff_count[]" value="0"></div>
                    <div><label>VIP開發</label><input type="number" name="staff_vip[]" value="0"></div>
                    <div><label>展示照片</label><input type="number" name="photo_show[]" value="0"></div>
                </div>
            `;
            container.appendChild(div);
        }

        const form = document.getElementById('storeForm');
        form.addEventListener('submit', e => {
            e.preventDefault();
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('submitBtn').disabled = true;

            fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: new FormData(form)
            })
            .then(() => {
                alert('數據已儲存！請至 LINE 貼上回報。');
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                generatePreview();
            })
            .catch(err => {
                console.error('Error:', err);
                alert('同步異常，請使用預覽功能手動複製文字。');
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('submitBtn').disabled = false;
                generatePreview();
            });
        });

        function generatePreview() {
            const data = new FormData(form);
            const names = data.getAll('staff_name[]');
            const counts = data.getAll('staff_count[]');
            const vips = data.getAll('staff_vip[]');
            
            let perfText = "";
            let totalVip = 0;
            names.forEach((n, i) => { 
                if(n) {
                    perfText += `・${n}: ${counts[i]} 件 [VIP:+${vips[i]}]\n`; 
                    totalVip += parseInt(vips[i]) || 0;
                }
            });

            let report = `《${data.get('store_name')}》人員績效報告\n`;
            report += `日期：${data.get('date')} (${data.get('weekday')})\n`;
            report += `今日總 VIP 開發：${totalVip}\n\n`;
            report += `《個人績效明細》\n${perfText}\n`;
            report += `《門店分析》\n${data.get('analysis') || '無'}\n\n`;
            report += `《異常/熱銷/補貨》\n${data.get('feedback') || '無'}\n${data.get('restock') || ''}`;

            document.getElementById('resultText').innerText = report;
            document.getElementById('resultContainer').classList.remove('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function copyToClipboard() {
            const text = document.getElementById('resultText').innerText;
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert('回報文字已複製！');
        }
    </script>
</body>
</html>
